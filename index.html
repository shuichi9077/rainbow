<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow.UX</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="style.css"> <!-- Assume que o style.css está na mesma pasta -->
</head>
<body>
    <div class="barra-topo">
        <div class="logo">
            <i class="ri-rainbow-line" style="color: #3b82f6;"></i> RAINBOW.UX
        </div>
        <div class="controles-topo">
            <div class="grupo-nome" style="display:flex; align-items:center; margin-right:20px; gap:10px;">
                <label style="color:#94a3b8; font-size:0.8rem;">PROJETO:</label>
                <input type="text" id="nome-projeto" value="Meu Site Incrível" class="input-texto" style="width:200px; height:35px;">
            </div>
            <button class="btn-acao outline" onclick="gerador.alternarView('desktop')"><i class="ri-macbook-line"></i></button>
            <button class="btn-acao outline" onclick="gerador.alternarView('mobile')"><i class="ri-smartphone-line"></i></button>
            <button class="btn-acao" onclick="gerador.baixarZip()"><i class="ri-download-cloud-2-line"></i> Exportar ZIP</button>
        </div>
    </div>

    <div class="area-trabalho">
        <!-- EDITOR LATERAL -->
        <div class="lateral-editor" id="painel-editor">
            <!-- Injetado via JS -->
        </div>

        <!-- PREVIEW -->
        <div class="area-preview" id="wrapper-preview">
            <div class="frame-wrapper">
                <div class="frame-header">
                    <div class="bola red"></div>
                    <div class="bola yellow"></div>
                    <div class="bola green"></div>
                </div>
                <iframe id="frame-site"></iframe>
            </div>
        </div>
    </div>

    <script>
        /**
         * RAINBOW.UX ENGINE v4.1 PROFESSIONAL (UPDATED)
         * Changelog v4.1:
         * - Aumento de limite de upload para 3MB.
         * - Novos layouts de galeria: Grid e Masonry.
         */

        const ESTILOS_PADRAO = {
            fundo: '#ffffff', texto: '#1e293b', padding: 80, borda: 0, layout: 'container'
        };

        const estadoPadrao = {
            global: {
                fonte: 'Inter',
                corPrimaria: '#2563eb',
                corSecundaria: '#1e293b'
            },
            secoes: [
                {
                    id: 'cabecalho', tipo: 'header', titulo: 'Cabeçalho & Navegação', ativo: true,
                    dados: { logoTexto: 'rainbow.UX', logoImg: null, links: ['Home', 'Serviços', 'Contato'] },
                    estilo: { ...ESTILOS_PADRAO, fundo: '#ffffff', padding: 20, layout: 'full', sombra: true }
                },
                {
                    id: 'hero', tipo: 'hero', titulo: 'Banner Principal (Hero)', ativo: true,
                    dados: { 
                        titulo: 'Eleve seu Negócio', 
                        subtitulo: 'Soluções digitais de alta performance para empresas que buscam o extraordinário.', 
                        btn1: 'Começar Agora', btn2: 'Ver Portfólio',
                        bgImg: null, bgOverlay: 0.6
                    },
                    estilo: { ...ESTILOS_PADRAO, fundo: '#1e293b', texto: '#ffffff', padding: 120, layout: 'full', alinhar: 'center' }
                },
                {
                    id: 'servicos', tipo: 'grid', titulo: 'Grid de Serviços', ativo: true,
                    dados: {
                        titulo: 'O Que Fazemos',
                        itens: [
                            { titulo: 'Consultoria', texto: 'Análise estratégica para seu crescimento.' },
                            { titulo: 'Design UI/UX', texto: 'Interfaces que encantam e convertem.' },
                            { titulo: 'Desenvolvimento', texto: 'Código limpo e performático.' }
                        ]
                    },
                    estilo: { ...ESTILOS_PADRAO, fundo: '#f8fafc', colunas: 3, cardFundo: '#ffffff', borda: 12 }
                },
                {
                    id: 'flex', tipo: 'flex', titulo: 'Destaque Flexível', ativo: true,
                    dados: {
                        titulo: 'História da Empresa',
                        texto: 'Fundada em 2024, nossa missão é simplificar a web. Utilizamos tecnologia de ponta para entregar resultados.',
                        imagem: null,
                        posicaoImg: 'right' // left, right
                    },
                    estilo: { ...ESTILOS_PADRAO, padding: 100 }
                },
                {
                    id: 'galeria', tipo: 'carousel', titulo: 'Portfólio / Galeria', ativo: true,
                    dados: { titulo: 'Nossos Projetos', imagens: [] }, // Array of {file, url}
                    // UPDATE: Adicionado layout 'carousel' e colunas 3 como padrão
                    estilo: { ...ESTILOS_PADRAO, fundo: '#111827', texto: '#ffffff', layout: 'carousel', colunas: 3 }
                },
                {
                    id: 'faq', tipo: 'faq', titulo: 'Perguntas Frequentes', ativo: false,
                    dados: {
                        titulo: 'Dúvidas?',
                        itens: [
                            { p: 'Vocês dão suporte?', r: 'Sim, suporte 24/7 incluso.' },
                            { p: 'Qual o prazo?', r: 'Entrega em até 5 dias úteis.' }
                        ]
                    },
                    estilo: { ...ESTILOS_PADRAO, fundo: '#ffffff' }
                },
                {
                    id: 'contato', tipo: 'form', titulo: 'Contato', ativo: true,
                    dados: { titulo: 'Vamos Conversar', email: 'contato@empresa.com' },
                    estilo: { ...ESTILOS_PADRAO, fundo: '#eff6ff', borda: 16 }
                },
                {
                    id: 'rodape', tipo: 'footer', titulo: 'Rodapé', ativo: true,
                    dados: { texto: '© 2025 Rainbow. Todos os direitos reservados.', social: true },
                    estilo: { ...ESTILOS_PADRAO, fundo: '#0f172a', texto: '#94a3b8', padding: 40 }
                }
            ]
        };

        class RainbowEngine {
            constructor() {
                this.dados = JSON.parse(JSON.stringify(estadoPadrao));
                this.arquivos = {}; // Armazena blobs reais para o ZIP
                this.painel = document.getElementById('painel-editor');
                this.frame = document.getElementById('frame-site');
                this.init();
            }

            init() {
                this.renderizarEditor();
                this.atualizarPreview();
                document.getElementById('nome-projeto').addEventListener('input', () => this.atualizarPreview());
            }

            // --- UI RENDER ---
            renderizarEditor() {
                this.painel.innerHTML = '';
                this.dados.secoes.forEach((secao, idx) => {
                    const el = document.createElement('div');
                    el.className = 'secao-container';
                    el.innerHTML = `
                        <div class="cabecalho-secao ${secao.ativo ? 'ativo' : ''}" onclick="gerador.toggleSecao(${idx})">
                            <div class="titulo-secao">
                                <label class="switch" onclick="event.stopPropagation()">
                                    <input type="checkbox" ${secao.ativo ? 'checked' : ''} onchange="gerador.toggleAtivo(${idx}, this.checked)">
                                    <span class="slider"></span>
                                </label>
                                ${this.getIcone(secao.tipo)} ${secao.titulo}
                            </div>
                            <i class="ri-arrow-down-s-line" style="color:#64748b"></i>
                        </div>
                        <div class="conteudo-secao" id="conteudo-${idx}">
                            <div class="abas-secao">
                                <div class="aba ativa" onclick="gerador.mudarAba(${idx}, 'conteudo')">Conteúdo</div>
                                <div class="aba" onclick="gerador.mudarAba(${idx}, 'aparencia')">Aparência</div>
                                <div class="aba" onclick="gerador.mudarAba(${idx}, 'layout')">Layout & Ajustes</div>
                            </div>
                            <div class="painel-aba ativo" id="aba-conteudo-${idx}">
                                ${this.renderConteudo(secao, idx)}
                            </div>
                            <div class="painel-aba" id="aba-aparencia-${idx}">
                                ${this.renderAparencia(secao, idx)}
                            </div>
                            <div class="painel-aba" id="aba-layout-${idx}">
                                ${this.renderLayout(secao, idx)}
                            </div>
                        </div>
                    `;
                    this.painel.appendChild(el);
                });
            }

            getIcone(tipo) {
                const icones = { header: 'ri-layout-top-line', hero: 'ri-image-line', grid: 'ri-grid-fill', flex: 'ri-layout-column-line', carousel: 'ri-gallery-line', faq: 'ri-question-answer-line', form: 'ri-mail-send-line', footer: 'ri-layout-bottom-line' };
                return `<i class="${icones[tipo] || 'ri-layout-line'}"></i>`;
            }

            // --- RENDERIZADORES DE CAMPOS ---
            renderConteudo(s, idx) {
                let html = '';
                const d = s.dados;
                
                // Campos Comuns
                if(d.titulo !== undefined) html += this.campoInput(idx, 'titulo', 'Título Principal', d.titulo);
                if(d.subtitulo !== undefined) html += this.campoArea(idx, 'subtitulo', 'Subtítulo / Descrição', d.subtitulo);
                if(d.texto !== undefined) html += this.campoArea(idx, 'texto', 'Texto do Corpo', d.texto);

                // Específicos
                if(s.tipo === 'header') {
                    html += this.campoInput(idx, 'logoTexto', 'Nome da Marca (Texto)', d.logoTexto);
                    html += this.campoUpload(idx, 'logoImg', 'Upload Logo (PNG/SVG)', d.logoImg);
                }
                if(s.tipo === 'hero') {
                    html += this.campoInput(idx, 'btn1', 'Texto Botão Primário', d.btn1);
                    html += this.campoInput(idx, 'btn2', 'Texto Botão Secundário', d.btn2);
                    html += this.campoUpload(idx, 'bgImg', 'Imagem de Fundo (Alta Qualidade)', d.bgImg);
                }
                if(s.tipo === 'flex') {
                    html += this.campoSelect(idx, 'posicaoImg', 'Posição da Imagem', d.posicaoImg, [{v:'left', t:'Esquerda'}, {v:'right', t:'Direita'}, {v:'top', t:'Topo'}]);
                    html += this.campoUpload(idx, 'imagem', 'Imagem de Destaque', d.imagem);
                }
                if(s.tipo === 'grid' || s.tipo === 'faq') {
                    html += `<label style="color:#94a3b8; font-size:0.8rem; display:block; margin-top:10px;">ITENS DA LISTA</label>`;
                    html += `<div class="lista-itens">`;
                    d.itens.forEach((item, iItem) => {
                        html += `
                        <div class="item-lista">
                            <div class="cabecalho-item"><span>Item #${iItem+1}</span> <i class="ri-delete-bin-line btn-remove-item" onclick="gerador.removeItem(${idx}, ${iItem})"></i></div>
                            <input type="text" class="input-texto" value="${item.titulo || item.p}" oninput="gerador.atualizarItem(${idx}, ${iItem}, '${item.titulo ? 'titulo':'p'}', this.value)" placeholder="Título/Pergunta" style="margin-bottom:5px;">
                            <textarea class="input-texto" rows="2" oninput="gerador.atualizarItem(${idx}, ${iItem}, '${item.texto ? 'texto':'r'}', this.value)" placeholder="Texto/Resposta">${item.texto || item.r}</textarea>
                        </div>`;
                    });
                    html += `<button class="btn-add-item" onclick="gerador.adicionarItem(${idx})">+ Adicionar Novo Item</button></div>`;
                }
                if(s.tipo === 'carousel') {
                    // UPDATE: Mensagem de peso atualizada
                    html += this.campoUploadMulti(idx, 'Adicionar Imagens (Max 3MB)');
                }
                
                return html;
            }

            renderAparencia(s, idx) {
                const e = s.estilo;
                let html = '';
                html += this.campoCor(idx, 'fundo', 'Cor de Fundo', e.fundo);
                html += this.campoCor(idx, 'texto', 'Cor do Texto', e.texto);
                if(s.tipo === 'grid') html += this.campoCor(idx, 'cardFundo', 'Cor do Cartão', e.cardFundo);
                if(s.tipo === 'hero') {
                    html += `<div class="grupo-campo"><label>Opacidade da Sombra (Overlay)</label><div class="input-range-wrapper"><input type="range" class="input-range" min="0" max="1" step="0.1" value="${s.dados.bgOverlay}" oninput="gerador.atualizarDado(${idx}, 'bgOverlay', this.value)"><span class="range-valor">${s.dados.bgOverlay}</span></div></div>`;
                }
                return html;
            }

            renderLayout(s, idx) {
                const e = s.estilo;
                let html = '';
                
                // Padding Vertical
                html += `<div class="grupo-campo"><label>Altura / Espaçamento (Padding)</label><div class="input-range-wrapper"><input type="range" class="input-range" min="0" max="200" step="10" value="${e.padding}" oninput="gerador.atualizarEstilo(${idx}, 'padding', this.value)"><span class="range-valor">${e.padding}px</span></div></div>`;
                
                // Bordas
                if(s.tipo === 'grid' || s.tipo === 'contato') {
                    html += `<div class="grupo-campo"><label>Arredondamento (Border Radius)</label><div class="input-range-wrapper"><input type="range" class="input-range" min="0" max="50" value="${e.borda}" oninput="gerador.atualizarEstilo(${idx}, 'borda', this.value)"><span class="range-valor">${e.borda}px</span></div></div>`;
                }

                // Grid Columns
                if(s.tipo === 'grid') {
                    html += this.campoSelect(idx, 'colunas', 'Colunas no Desktop', e.colunas, [{v:2, t:'2 Colunas'}, {v:3, t:'3 Colunas'}, {v:4, t:'4 Colunas'}]);
                }

                // UPDATE: Opções de Layout para Galeria
                if(s.tipo === 'carousel') {
                    html += this.campoSelect(idx, 'layout', 'Estilo de Exibição', e.layout || 'carousel', [
                        {v:'carousel', t:'Carrossel Deslizante'},
                        {v:'grid', t:'Grid Padrão (Quadrado)'},
                        {v:'masonry', t:'Mosaico (Masonry)'}
                    ]);
                    
                    // Mostrar seletor de colunas se não for carrossel
                    if(e.layout !== 'carousel') {
                        html += this.campoSelect(idx, 'colunas', 'Número de Colunas', e.colunas || 3, [
                            {v:2, t:'2 Colunas'},
                            {v:3, t:'3 Colunas'},
                            {v:4, t:'4 Colunas'}
                        ]);
                    }
                }

                // Alinhamento Hero
                if(s.tipo === 'hero') {
                    html += this.campoSelect(idx, 'alinhar', 'Alinhamento do Texto', e.alinhar, [{v:'left', t:'Esquerda'}, {v:'center', t:'Centro'}]);
                }

                return html;
            }

            // --- UI HELPERS ---
            campoInput(idx, key, label, val) { return `<div class="grupo-campo"><label>${label}</label><input type="text" class="input-texto" value="${val}" oninput="gerador.atualizarDado(${idx}, '${key}', this.value)"></div>`; }
            campoArea(idx, key, label, val) { return `<div class="grupo-campo"><label>${label}</label><textarea rows="3" oninput="gerador.atualizarDado(${idx}, '${key}', this.value)">${val}</textarea></div>`; }
            campoCor(idx, key, label, val) { return `<div class="grupo-campo"><label>${label}</label><div style="display:flex; gap:10px;"><input type="color" value="${val}" oninput="gerador.atualizarEstilo(${idx}, '${key}', this.value)" style="height:35px; width:50px; border:none; background:none; cursor:pointer;"><input type="text" class="input-texto" value="${val}" readonly></div></div>`; }
            campoSelect(idx, key, label, val, opts) { 
                // Verifica se precisa atualizar o editor (para mostrar/ocultar campos condicionais como colunas)
                const refreshEditor = (key === 'layout');
                const action = refreshEditor ? 
                    `gerador.atualizarEstiloEEditor(${idx}, '${key}', this.value)` : 
                    `gerador.atualizar${key === 'colunas' || key === 'alinhar' ? 'Estilo' : 'Dado'}(${idx}, '${key}', this.value)`;
                
                return `<div class="grupo-campo"><label>${label}</label><select onchange="${action}">${opts.map(o => `<option value="${o.v}" ${val == o.v ? 'selected':''}>${o.t}</option>`).join('')}</select></div>`; 
            }
            
            campoUpload(idx, key, label, preview) {
                return `
                <div class="grupo-campo">
                    <label>${label}</label>
                    <div class="upload-area" onclick="document.getElementById('file-${idx}-${key}').click()">
                        <i class="ri-upload-cloud-line" style="font-size:1.5rem; color:var(--destaque)"></i>
                        <p>Clique para selecionar (Max 3MB)</p>
                    </div>
                    <div id="erro-${idx}-${key}" class="aviso-erro"><i class="ri-error-warning-line"></i> Arquivo muito grande! Max 3MB.</div>
                    <input type="file" id="file-${idx}-${key}" accept="image/*" style="display:none" onchange="gerador.handleUpload(${idx}, '${key}', this)">
                    ${preview ? `<img src="${preview}" class="preview-thumb" style="margin-top:10px; height:auto; max-height:100px;">` : ''}
                </div>`;
            }

            campoUploadMulti(idx, label) {
                const imagens = this.dados.secoes[idx].dados.imagens;
                return `
                <div class="grupo-campo">
                    <label>${label}</label>
                    <div class="upload-area" onclick="document.getElementById('multi-${idx}').click()">
                        <i class="ri-gallery-upload-line" style="font-size:1.5rem; color:var(--destaque)"></i>
                        <p>Adicionar Imagens (Max 3MB cada)</p>
                    </div>
                    <input type="file" id="multi-${idx}" multiple accept="image/*" style="display:none" onchange="gerador.handleMultiUpload(${idx}, this)">
                    <div class="preview-grid">
                        ${imagens.map(img => `<img src="${img.url}" class="preview-thumb">`).join('')}
                    </div>
                </div>`;
            }

            // --- LÓGICA ---
            handleUpload(idx, key, input) {
                const file = input.files[0];
                if(!file) return;

                // UPDATE: Limite aumentado para 3MB
                if(file.size > 3 * 1024 * 1024) { 
                    document.getElementById(`erro-${idx}-${key}`).style.display = 'block';
                    return;
                }
                document.getElementById(`erro-${idx}-${key}`).style.display = 'none';

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.dados.secoes[idx].dados[key] = e.target.result; // Preview
                    this.arquivos[`${idx}_${key}`] = { file: file, name: `img_${idx}_${key}_${file.name.replace(/\s/g,'_')}` };
                    this.renderizarEditor(); // Re-render to show preview
                    this.atualizarPreview();
                };
                reader.readAsDataURL(file);
            }

            handleMultiUpload(idx, input) {
                Array.from(input.files).forEach((file, i) => {
                    // UPDATE: Limite aumentado para 3MB
                    if(file.size > 3 * 1024 * 1024) { alert(`A imagem ${file.name} tem mais de 3MB e foi ignorada.`); return; }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.dados.secoes[idx].dados.imagens.push({ url: e.target.result });
                        this.arquivos[`${idx}_galeria_${Date.now()}_${i}`] = { file: file, name: `gallery_${idx}_${i}_${file.name}` };
                        if(i === input.files.length - 1) {
                            this.renderizarEditor();
                            this.atualizarPreview();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            // Atualizadores de Estado
            toggleSecao(idx) { 
                const el = document.getElementById(`conteudo-${idx}`);
                el.classList.toggle('aberto'); 
            }
            toggleAtivo(idx, val) { this.dados.secoes[idx].ativo = val; this.atualizarPreview(); }
            mudarAba(idx, aba) {
                const root = document.getElementById(`conteudo-${idx}`);
                root.querySelectorAll('.aba').forEach(e => e.classList.remove('ativa'));
                root.querySelectorAll('.painel-aba').forEach(e => e.classList.remove('ativo'));
                // Simples lógica de index
                const map = { conteudo: 0, aparencia: 1, layout: 2 };
                root.querySelectorAll('.aba')[map[aba]].classList.add('ativa');
                document.getElementById(`aba-${aba}-${idx}`).classList.add('ativo');
            }
            atualizarDado(idx, key, val) { this.dados.secoes[idx].dados[key] = val; this.atualizarPreview(); }
            atualizarEstilo(idx, key, val) { this.dados.secoes[idx].estilo[key] = val; this.atualizarPreview(); }
            
            // Novo helper para atualizar e re-renderizar o editor (útil para mostrar campos condicionais)
            atualizarEstiloEEditor(idx, key, val) {
                this.dados.secoes[idx].estilo[key] = val;
                this.renderizarEditor(); // Redesenha o editor para mostrar/ocultar colunas
                this.atualizarPreview();
                // Reabre a seção e aba layout pois o renderizar fecha tudo por padrão
                setTimeout(() => {
                    document.getElementById(`conteudo-${idx}`).classList.add('aberto');
                    this.mudarAba(idx, 'layout');
                }, 50);
            }

            // Listas
            atualizarItem(idxItem, iSub, key, val) {
                if(key === 'titulo' || key === 'p') this.dados.secoes[idxItem].dados.itens[iSub][key === 'titulo' ? 'titulo' : 'p'] = val;
                else this.dados.secoes[idxItem].dados.itens[iSub][key === 'texto' ? 'texto' : 'r'] = val;
                this.atualizarPreview();
            }
            adicionarItem(idx) {
                const novo = this.dados.secoes[idx].tipo === 'grid' ? { titulo:'Novo', texto:'...' } : { p:'Pergunta?', r:'Resposta.' };
                this.dados.secoes[idx].dados.itens.push(novo);
                this.renderizarEditor(); this.atualizarPreview();
            }
            removeItem(idx, subIdx) {
                this.dados.secoes[idx].dados.itens.splice(subIdx, 1);
                this.renderizarEditor(); this.atualizarPreview();
            }

            alternarView(modo) {
                const wrap = document.getElementById('wrapper-preview');
                wrap.style.maxWidth = modo === 'mobile' ? '375px' : '100%';
            }

            // --- GERAÇÃO DE CÓDIGO (ENGINE) ---

            gerarCSS() {
                const { fonte, corPrimaria, corSecundaria } = this.dados.global;
                return `
/* RAINBOW.UX PROFESSIONAL STYLE */
@import url('https://fonts.googleapis.com/css2?family=${fonte}:wght@300;400;600;800&display=swap');

:root {
    --primary: ${corPrimaria};
    --secondary: ${corSecundaria};
    --text-main: #1e293b;
    --bg-body: #ffffff;
    --radius-sm: 8px;
    --radius-md: 12px;
    --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
}

* { margin:0; padding:0; box-sizing:border-box; font-family: '${fonte}', sans-serif; }
body { color: var(--text-main); line-height: 1.7; overflow-x: hidden; }
img { max-width: 100%; height: auto; display: block; }
a { text-decoration: none; color: inherit; transition: 0.3s; }
ul { list-style: none; }

/* UTILS */
.container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
.btn { 
    display: inline-flex; align-items: center; justify-content: center;
    padding: 14px 32px; font-weight: 600; border-radius: 50px; 
    transition: all 0.3s; cursor: pointer; border: none; font-size: 1rem;
    box-shadow: 0 4px 14px 0 rgba(0,0,0,0.1);
}
.btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
.btn-primary { background: var(--primary); color: white; }
.btn-outline { border: 2px solid white; color: white; background: transparent; }
.btn-outline:hover { background: white; color: var(--text-main); }

/* SECTIONS */
section { position: relative; }
h1, h2, h3 { line-height: 1.2; margin-bottom: 1rem; font-weight: 800; letter-spacing: -0.02em; }
h1 { font-size: 3.5rem; } h2 { font-size: 2.5rem; } h3 { font-size: 1.5rem; }
p { opacity: 0.85; margin-bottom: 1.5rem; }

/* COMPONENTS */
.grid-cards { display: grid; gap: 30px; }
.card { padding: 30px; transition: 0.3s; height: 100%; display: flex; flex-direction: column; }
.card:hover { transform: translateY(-10px); box-shadow: var(--shadow); }

/* CAROUSEL */
.carousel { position: relative; overflow: hidden; width: 100%; height: 500px; border-radius: var(--radius-md); }
.carousel-track { display: flex; transition: transform 0.5s ease-in-out; height: 100%; }
.carousel-slide { min-width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center; }
.carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 15px; cursor: pointer; z-index: 10; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
.carousel-btn:hover { background: var(--primary); }
.prev { left: 20px; } .next { right: 20px; }

/* NEW: GALLERY LAYOUTS */
/* Grid */
.gallery-grid { display: grid; gap: 20px; }
.gallery-item { overflow: hidden; border-radius: var(--radius-md); position: relative; }
.gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
.gallery-item:hover img { transform: scale(1.05); }

/* Masonry */
.gallery-masonry { column-gap: 20px; }
.gallery-masonry .gallery-item { margin-bottom: 20px; break-inside: avoid; }
.gallery-masonry img { width: 100%; display: block; border-radius: var(--radius-md); }

/* FAQ */
.faq-item { border-bottom: 1px solid rgba(0,0,0,0.1); padding: 20px 0; }
.faq-question { font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.faq-answer { max-height: 0; overflow: hidden; transition: 0.3s; opacity: 0; }
.faq-item.active .faq-answer { max-height: 200px; opacity: 1; margin-top: 10px; }
.faq-icon { transition: 0.3s; }
.faq-item.active .faq-icon { transform: rotate(180deg); }

/* FORM */
.form-group { margin-bottom: 20px; }
.form-control { width: 100%; padding: 15px; border: 1px solid #e2e8f0; border-radius: var(--radius-sm); background: white; }
.form-control:focus { border-color: var(--primary); outline: none; }

/* RESPONSIVE */
@media(max-width: 768px) {
    h1 { font-size: 2.5rem; } h2 { font-size: 2rem; }
    .nav-links { display: none; }
    .grid-cards { grid-template-columns: 1fr !important; }
    .flex-row { flex-direction: column !important; }
    .flex-row.reverse { flex-direction: column-reverse !important; }
    
    /* Gallery Responsive */
    .gallery-grid { grid-template-columns: 1fr !important; }
    .gallery-masonry { column-count: 1 !important; }
}
`;
            }

            gerarHTML(isExport = false) {
                const resolverSrc = (key, secaoIdx) => {
                    if(isExport) {
                        // Tenta achar no objeto de arquivos
                        const fileKey = `${secaoIdx}_${key}`;
                        if(this.arquivos[fileKey]) return `assets/${this.arquivos[fileKey].name}`;
                        // Fallback para galeria
                        const galeriaKey = Object.keys(this.arquivos).find(k => k.startsWith(`${secaoIdx}_galeria`) && k.includes(key)); 
                        return ''; 
                    }
                    return this.dados.secoes[secaoIdx].dados[key];
                }

                // Resolver Galeria especificamente
                const resolverGaleria = (secaoIdx) => {
                    if(!isExport) return this.dados.secoes[secaoIdx].dados.imagens;
                    // Retorna lista com caminhos 'assets/...'
                    const imgs = [];
                    for(let k in this.arquivos) {
                        if(k.startsWith(`${secaoIdx}_galeria`)) imgs.push(`assets/${this.arquivos[k].name}`);
                    }
                    return imgs.map(url => ({url}));
                }

                let html = `<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${document.getElementById('nome-projeto').value}</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Ícones -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>
<body>`;

                this.dados.secoes.forEach((s, idx) => {
                    if(!s.ativo) return;
                    const d = s.dados;
                    const e = s.estilo;
                    
                    // Injeção de Estilo Inline para essa seção
                    const style = `background:${e.fundo}; color:${e.texto}; padding:${e.padding}px 0;`;

                    // HEADER
                    if(s.tipo === 'header') {
                        const logo = resolverSrc('logoImg', idx);
                        html += `
    <header style="background:${e.fundo}; padding:${e.padding}px 0; position:sticky; top:0; z-index:100; box-shadow: ${s.estilo.sombra ? '0 4px 20px rgba(0,0,0,0.05)' : 'none'};">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <a href="#" style="font-weight:900; font-size:1.5rem; color:${e.texto}; display:flex; align-items:center; gap:10px;">
                ${logo ? `<img src="${logo}" style="height:40px;">` : ''} ${d.logoTexto}
            </a>
            <nav class="nav-links">
                ${d.links.map(l => `<a href="#${l.toLowerCase()}" style="margin-left:30px; font-weight:600; font-size:0.95rem;">${l}</a>`).join('')}
            </nav>
            <button class="mobile-toggle" style="background:none; border:none; font-size:1.5rem; display:none;">☰</button>
        </div>
    </header>`;
                    }

                    // HERO
                    if(s.tipo === 'hero') {
                        const bg = resolverSrc('bgImg', idx);
                        html += `
    <section id="hero" style="${style} min-height:80vh; display:flex; align-items:center; position:relative; overflow:hidden;">
        ${bg ? `<div style="position:absolute; top:0; left:0; width:100%; height:100%; background:url('${bg}') center/cover;"></div>` : ''}
        <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:black; opacity:${d.bgOverlay};"></div>
        <div class="container" style="position:relative; z-index:2; text-align:${e.alinhar};">
            <h1 style="color:white; margin-bottom:20px;">${d.titulo}</h1>
            <p style="color:rgba(255,255,255,0.9); font-size:1.25rem; max-width:600px; margin:${e.alinhar === 'center' ? '0 auto' : '0'} 30px;">${d.subtitulo}</p>
            <div style="display:flex; gap:15px; justify-content:${e.alinhar}; flex-wrap:wrap;">
                ${d.btn1 ? `<a href="#contato" class="btn btn-primary">${d.btn1}</a>` : ''}
                ${d.btn2 ? `<a href="#portfolio" class="btn btn-outline">${d.btn2}</a>` : ''}
            </div>
        </div>
    </section>`;
                    }

                    // GRID SERVIÇOS
                    if(s.tipo === 'grid') {
                        html += `
    <section id="servicos" style="${style}">
        <div class="container">
            <h2 style="text-align:center; margin-bottom:50px;">${d.titulo}</h2>
            <div class="grid-cards" style="grid-template-columns: repeat(${e.colunas}, 1fr);">
                ${d.itens.map(item => `
                <div class="card" style="background:${e.cardFundo}; border-radius:${e.borda}px;">
                    <div style="width:50px; height:50px; background:var(--primary); border-radius:10px; margin-bottom:20px;"></div>
                    <h3 style="color:${e.texto}">${item.titulo}</h3>
                    <p>${item.texto}</p>
                </div>`).join('')}
            </div>
        </div>
    </section>`;
                    }

                    // FLEX IMAGE/TEXT
                    if(s.tipo === 'flex') {
                        const img = resolverSrc('imagem', idx);
                        const direcao = d.posicaoImg === 'right' ? '' : (d.posicaoImg === 'left' ? 'flex-direction:row-reverse;' : 'flex-direction:column-reverse; text-align:center;');
                        html += `
    <section id="sobre" style="${style}">
        <div class="container flex-row" style="display:flex; align-items:center; gap:50px; ${direcao}">
            <div style="flex:1;">
                <h2>${d.titulo}</h2>
                <p>${d.texto.replace(/\n/g, '<br>')}</p>
            </div>
            <div style="flex:1;">
                ${img ? `<img src="${img}" style="width:100%; border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,0.1);">` : '<div style="background:#eee; height:300px; border-radius:12px; display:flex; align-items:center; justify-content:center;">Sem Imagem</div>'}
            </div>
        </div>
    </section>`;
                    }

                    // GALERIA (UPDATED LOGIC)
                    if(s.tipo === 'carousel') {
                        const imgs = resolverGaleria(idx);
                        const layout = e.layout || 'carousel';
                        const cols = e.colunas || 3;

                        html += `
    <section id="galeria" style="${style}">
        <div class="container">
            <h2 style="text-align:center; margin-bottom:40px;">${d.titulo}</h2>
            ${imgs.length > 0 ? (() => {
                // LOGICA DE RENDERIZAÇÃO POR LAYOUT
                if (layout === 'carousel') {
                    return `
                    <div class="carousel" id="carousel-${idx}">
                        <button class="carousel-btn prev" onclick="moveSlide(${idx}, -1)">&#10094;</button>
                        <div class="carousel-track">
                            ${imgs.map(im => `<div class="carousel-slide" style="background-image:url('${im.url}')"></div>`).join('')}
                        </div>
                        <button class="carousel-btn next" onclick="moveSlide(${idx}, 1)">&#10095;</button>
                    </div>`;
                } else if (layout === 'grid') {
                    return `
                    <div class="gallery-grid" style="grid-template-columns: repeat(${cols}, 1fr);">
                         ${imgs.map(im => `
                            <div class="gallery-item" style="aspect-ratio: 1/1;">
                                <img src="${im.url}" alt="Projeto">
                            </div>
                         `).join('')}
                    </div>`;
                } else if (layout === 'masonry') {
                    return `
                    <div class="gallery-masonry" style="column-count: ${cols};">
                         ${imgs.map(im => `
                            <div class="gallery-item">
                                <img src="${im.url}" alt="Projeto" style="margin-bottom:20px;">
                            </div>
                         `).join('')}
                    </div>`;
                }
            })() : '<p style="text-align:center;">Adicione imagens para ver a galeria.</p>'}
        </div>
    </section>`;
                    }

                    // FAQ
                    if(s.tipo === 'faq') {
                        html += `
    <section id="faq" style="${style}">
        <div class="container" style="max-width:800px;">
            <h2 style="text-align:center; margin-bottom:40px;">${d.titulo}</h2>
            <div class="faq-list">
                ${d.itens.map(i => `
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        ${i.p} <i class="ri-arrow-down-s-line faq-icon"></i>
                    </div>
                    <div class="faq-answer"><p>${i.r}</p></div>
                </div>`).join('')}
            </div>
        </div>
    </section>`;
                    }

                    // CONTACT FORM
                    if(s.tipo === 'form') {
                        html += `
    <section id="contato" style="${style}">
        <div class="container" style="max-width:600px; background:white; padding:40px; border-radius:${e.borda}px; box-shadow:0 20px 50px rgba(0,0,0,0.05);">
            <h2 style="text-align:center; color:#1e293b;">${d.titulo}</h2>
            <form action="../backend/mail.php" method="POST">
                <div class="form-group"><input type="text" name="nome" class="form-control" placeholder="Seu Nome" required></div>
                <div class="form-group"><input type="email" name="email" class="form-control" placeholder="Seu E-mail" required></div>
                <div class="form-group"><textarea name="msg" class="form-control" rows="4" placeholder="Como podemos ajudar?" required></textarea></div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Enviar Mensagem</button>
            </form>
        </div>
    </section>`;
                    }

                    // FOOTER
                    if(s.tipo === 'footer') {
                        html += `
    <footer style="${style} border-top:1px solid rgba(255,255,255,0.1);">
        <div class="container" style="text-align:center;">
            <p style="margin:0; font-size:0.9rem;">${d.texto}</p>
        </div>
    </footer>`;
                    }
                });

                // JS SCRIPT INJECT
                html += `
    <script>
        // JS PURO - CAROUSEL E FAQ
        function toggleFaq(el) {
            el.parentElement.classList.toggle('active');
        }

        const carousels = {};
        function moveSlide(id, dir) {
            const track = document.querySelector('#carousel-'+id+' .carousel-track');
            if(!track) return;
            const slides = track.children;
            if(!carousels[id]) carousels[id] = 0;
            
            carousels[id] += dir;
            if(carousels[id] < 0) carousels[id] = slides.length - 1;
            if(carousels[id] >= slides.length) carousels[id] = 0;
            
            track.style.transform = 'translateX(-' + (carousels[id] * 100) + '%)';
        }

        document.querySelector('.mobile-toggle')?.addEventListener('click', () => {
            alert('Menu Mobile Toggle - Implementado no CSS responsivo');
        });
    <\/script>
</body>
</html>`;
                return html;
            }

            atualizarPreview() {
                const doc = this.frame.contentDocument || this.frame.contentWindow.document;
                doc.open();
                doc.write(this.gerarHTML(false) + `<style>${this.gerarCSS()}</style>`);
                doc.close();
            }

            baixarZip() {
                const zip = new JSZip();
                const folder = zip.folder(document.getElementById('nome-projeto').value.replace(/\s/g,'_').toLowerCase());
                
                // Frontend
                const front = folder.folder('frontend');
                front.file('index.html', this.gerarHTML(true));
                front.folder('css').file('style.css', this.gerarCSS());
                const assets = front.folder('assets');
                
                // Add Images
                for(let k in this.arquivos) {
                    assets.file(this.arquivos[k].name, this.arquivos[k].file);
                }

                // Backend
                const back = folder.folder('backend');
                back.file('mail.php', `<?php 
// Backend Simples
header('Content-Type: application/json');
if($_SERVER['REQUEST_METHOD'] == 'POST') {
    // mail(...);
    echo json_encode(['status'=>'success']);
}
?>`);

                zip.generateAsync({type:"blob"}).then(blob => saveAs(blob, "site_profissional_v4.zip"));
            }
        }

        const gerador = new RainbowEngine();
    </script>
</body>
</html>